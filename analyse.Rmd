---
title: "Analýzy k volbám 2018"
author: "petr.koci@rozhlas.cz"
output:
  html_notebook:
    toc: true
    toc_float: true
---

# 0. Stažní dat ČSÚ

Aktuální k 11. září 2018. [Co všechno data obsahují?](https://volby.cz/opendata/kv2018/KV2018regPopis.pdf).

```{r}
library(readxl)

# 2018
download.file("https://volby.cz/opendata/kv2018/KV2018reg20181031_xlsx.zip", "KV2018reg20181031_xlsx.zip")
unzip("KV2018reg20181031_xlsx.zip")
zastupitelstva18 <- read_excel("kvrzcoco.xlsx")
strany18 <- read_excel("kvros.xlsx")
kandidati18 <- read_excel("kvrk.xlsx")
file.remove(list.files(pattern="*.xlsx|*.xml|*.zip"))

# 2014
download.file("https://volby.cz/opendata/kv2014/KV2014reg20141014_xlsx.zip", "KV2014reg20141014_xlsx.zip")
unzip("KV2014reg20141014_xlsx.zip")
zastupitelstva14 <- read_excel("kvrzcoco.xlsx")
strany14 <- read_excel("kvros.xlsx")
kandidati14 <- read_excel("kvrk.xlsx")
file.remove(list.files(pattern="*.xlsx|*.xml|*.zip"))

# číselník okresů
download.file("https://volby.cz/opendata/kv2018/KV2018ciselniky20181031.zip", "ciselniky.zip")
unzip("ciselniky.zip")
nuts18 <- read_excel("cnumnuts.xlsx")
file.remove(list.files(pattern="*.xlsx|*.xml|*.zip"))
```


# 1. Počet kandidátů na mandát

Jaká je v jednotlivých obcích poptávka po práci v zastupitelstvu?

## Příprava dat
```{r}
library(tidyverse) 

# počet kandidátů v každém zastupitelstvu
kandidati_obce <- kandidati18 %>%
  group_by(KODZASTUP) %>%
  summarise(POCET_KANDIDATU=n())

# počet mandátů v každém zastupitelstvu, odebrat jednotlivé obvody, nechat jen celá zastupitelstva
zastupitelstva_mandaty <- zastupitelstva18 %>%
  filter(OBVODY!=2) %>%
  left_join(nuts18, by=c("OKRES" = "NUMNUTS")) %>%
  select(KODZASTUP, MANDATY, NAZEVZAST, NAZEVNUTS)
```


## Obce, kde nekandiduje nikdo

Našli jsme devět obcí, kde nekandiduje nikdo. Největší z nich je Lipovec v okrese Blansko, nejbližší Roblín v Praze-západ.

```{r}
nikdo <- zastupitelstva_mandaty %>%
  anti_join(kandidati_obce) %>%
  arrange(desc(MANDATY))
nikdo
```

Týká se to obcí, které mají celkem 3050 obyvatel.

```{r}
nikdo %>%
  left_join(zastupitelstva18) %>%
  select(POCOBYV) %>%
  sum()
```


## Kde je kandidátů míň než mandátů

V sedmnácti obcích je kandidátů méně než mandátů a nepodaří se v nich tedy naplnit zastupitelstvo. Největší takovou obcí jsou Tatobity v okrese Semily.

```{r}
min <- zastupitelstva_mandaty %>%
  left_join(kandidati_obce) %>%
  mutate(KANDIDATU_NA_MANDAT=POCET_KANDIDATU/MANDATY) %>%
  filter(KANDIDATU_NA_MANDAT<1) %>%
  arrange(KANDIDATU_NA_MANDAT)
min
```

Týká se to obcí, které mají celkem 5400 obyvatel.

```{r}
min %>%
  left_join(zastupitelstva18) %>%
  select(POCOBYV) %>%
  sum()
```


## Kde je přesně jeden kandidát na mandát

V 857 obcích, tedy zhruba ve 13 procentech ze všech, jsou volby jen formalitou, protože kandidátů je stejně jako mandátů.

```{r}
jeden <- zastupitelstva_mandaty %>%
  left_join(kandidati_obce) %>%
  mutate(KANDIDATU_NA_MANDAT=POCET_KANDIDATU/MANDATY) %>%
  filter(KANDIDATU_NA_MANDAT==1) %>%
  arrange(desc(MANDATY))
jeden
```

Týká se to obcí, které mají celkem 363 248.

```{r}
jeden %>%
  left_join(zastupitelstva18) %>%
  select(POCOBYV) %>%
  sum()
```


## Kde je největší poptávka po práci v zastupitelstvu?

Nejvíc lidí usiluje o jeden mandát v Praze (24 kandidátů na mandát) a v krajských městech. Mimo krajská města a jejich městské části je mimořádně vysoká konkurence v Šumperku, ve Strakonicích,v Hodoníně, v Jirkově, v České Lípě či v Opavě (13 kandidátů na mandát).

```{r}
zastupitelstva_mandaty %>%
  left_join(kandidati_obce) %>%
  mutate(KANDIDATU_NA_MANDAT=POCET_KANDIDATU/MANDATY) %>%
  distinct() %>%
  arrange(desc(KANDIDATU_NA_MANDAT))
```


# Počet kandidujících subjektů v obcích 

```{r}
download.file("https://volby.cz/opendata/kv2018/KV2018reg20181031_xlsx.zip", "KV2018reg20181031_xlsx.zip")
unzip("KV2018reg20181031_xlsx.zip")
library(readxl)
kandidatky_obce <- read_excel("kvros.xlsx")
```

```{r}
hist(table(kandidatky_obce$KODZASTUP))
```

```{r}
  quantile(table(kandidatky_obce$KODZASTUP), prob = c(0.2, 0.4, 0.6, 0.8, 0.85, 0.9, 0.95, 1))
```

Takže pro 80 procent obcí stačí udělat si místo na 7 stran, pro 90 procent 9 stran, pro 95 procent 11 stran. Blbý je, že, mezi těmi pěti procenty, který mají víc než 11 stran, jsou prakticky všechna velká města, viz tabulka:

```{r}
  library(dplyr)
  kandidatky_obce %>%
    group_by(KODZASTUP, NAZEVZAST) %>%
    summarise(pocet=n()) %>%
    filter(pocet>11) %>%
    arrange(desc(pocet))
```

## Navrhuju uříznout to na 16
Když uděláme ve sčítací aplikaci místo pro 16 stran, vejdou se nám na jednu stránku všechny kandidátky ve všech krajských městech s výjimkou Brna (22 subjektů). Nevleze se ani Praha hl. m. (29) a Praha 9 (28). Jinak všechny důležité obce ano.